<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PDF –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- –ù–∞—à CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="d-flex align-items-center justify-content-center vh-100">
<div class="card shadow-lg p-4 rounded-4" style="min-width: 400px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">PDF ‚Üí Word / Excel</h3>
        <button id="toggle-theme" class="btn btn-outline-secondary btn-sm">üåô</button>
    </div>

    <form id="convert-form">
        <div class="mb-3">
            <label class="form-label">–ó–∞–≥—Ä—É–∑–∫–∞ PDF:</label>
            <div id="drop-zone" class="drop-zone border border-2 border-dashed rounded p-3 text-center bg-light">
                <p id="drop-text" class="m-0 text-muted">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ PDF-—Ñ–∞–π–ª—ã –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
                <input id="file-input" class="form-control d-none" type="file" name="file" accept="application/pdf" multiple required>
            </div>
            <ul id="file-list" class="list-group mt-2 small" style="max-height: 150px; overflow-y: auto;"></ul>
            <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ PDF-—Ñ–∞–π–ª–æ–≤.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:</label>
            <select class="form-select" name="format" required>
                <option value="docx">Word (.docx)</option>
                <option value="xlsx">Excel (.xlsx)</option>
            </select>
            <div class="form-text">Word ‚Äî –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤, Excel ‚Äî –¥–ª—è —Ç–∞–±–ª–∏—Ü.</div>
        </div>

        <div id="status" class="mb-3 text-center text-info" style="display:none;">‚è≥ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...</div>
        <div id="error" class="mb-3 text-center text-danger" style="display:none;"></div>
        <div id="success" class="mb-3 text-center text-success" style="display:none;"></div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </form>
</div>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    const toggleBtn = document.getElementById('toggle-theme');
    const body = document.body;
    const card = document.querySelector('.card');
    const theme = localStorage.getItem('theme');

    if (theme === 'dark') {
        body.classList.add('dark');
        card.classList.add('dark');
        toggleBtn.textContent = '‚òÄÔ∏è';
    }

    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark');
        card.classList.toggle('dark');
        const isDark = body.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        toggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    });

    // Drag and drop
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const dropText = document.getElementById('drop-text');
    const fileList = document.getElementById('file-list');

    dropZone.addEventListener('click', () => fileInput.click());

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-info-subtle');
            dropText.textContent = '–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª—ã –∑–¥–µ—Å—å...';
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-info-subtle');
            dropText.textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ PDF-—Ñ–∞–π–ª—ã –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ';
        });
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            updateFileList(fileInput.files);
        }
    });

    fileInput.addEventListener('change', () => {
        updateFileList(fileInput.files);
    });

    function updateFileList(files) {
        fileList.innerHTML = '';
        if (files.length === 0) {
            const item = document.createElement('li');
            item.className = 'list-group-item text-muted';
            item.textContent = '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
            fileList.appendChild(item);
            return;
        }
        for (let i = 0; i < files.length; i++) {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            const name = document.createElement('span');
            name.textContent = files[i].name;
            const size = document.createElement('small');
            size.textContent = (files[i].size / 1024).toFixed(1) + ' KB';
            item.appendChild(name);
            item.appendChild(size);
            fileList.appendChild(item);
        }
    }

    // AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞
    const form = document.getElementById('convert-form');
    const status = document.getElementById('status');
    const errorBox = document.getElementById('error');
    const successBox = document.getElementById('success');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        status.style.display = 'block';
        errorBox.style.display = 'none';
        successBox.style.display = 'none';
        status.textContent = '‚è≥ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...';

        const formData = new FormData();
        const files = fileInput.files;
        const format = document.querySelector('select[name="format"]').value;

        for (let i = 0; i < files.length; i++) {
            formData.append('file', files[i]);
        }
        formData.append('format', format);

        try {
            const response = await fetch('/convert', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏');
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'result.zip';

            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+?)"/);
                if (match) {
                    filename = match[1];
                }
            }

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            status.style.display = 'none';
            successBox.textContent = '‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!';
            successBox.style.display = 'block';
        } catch (err) {
            status.style.display = 'none';
            errorBox.textContent = `‚ùå ${err.message}`;
            errorBox.style.display = 'block';
        }
    });
</script>

</body>
</html>
